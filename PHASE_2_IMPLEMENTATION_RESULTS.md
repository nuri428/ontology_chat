# Phase 2 êµ¬í˜„ ê²°ê³¼: í†µí•© í”„ë¡¬í”„íŠ¸ ìµœì í™”

**ì™„ë£Œ ì‹œê°„**: 2025-10-02
**ëª©í‘œ**: LLM í˜¸ì¶œ 8-10íšŒ â†’ 2-3íšŒë¡œ ì¶•ì†Œ

---

## âœ… ì™„ë£Œëœ ì‘ì—…

### Phase 1: Query Analysis Unified (ì´ì „ ì„¸ì…˜ ì™„ë£Œ)
- **ë³€ê²½**: `_analyze_query` ë©”ì„œë“œ í†µí•©
- **íš¨ê³¼**: 2íšŒ LLM í˜¸ì¶œ â†’ 1íšŒë¡œ ì¶•ì†Œ
- **ì‹¤ì œ ì„±ëŠ¥**: 3.1ì´ˆ (ì•ˆì •ì )

### Phase 2: Comprehensive Analysis & Report Unified (ê¸ˆì¼ ì™„ë£Œ)
- **ë³€ê²½**: `_generate_insights` + `_analyze_relationships` + `_synthesize_report` â†’ `_comprehensive_analysis_and_report`
- **íš¨ê³¼**: 5-9íšŒ LLM í˜¸ì¶œ â†’ 1íšŒë¡œ ì¶•ì†Œ
- **ì‹¤ì œ ì„±ëŠ¥**: 13.8ì´ˆ (1íšŒ LLM í˜¸ì¶œ)

### ì›Œí¬í”Œë¡œìš° ìµœì í™”
- **ì´ì „ ì›Œí¬í”Œë¡œìš°**:
  ```
  analyze_query (2 calls)
    â†’ collect_data
    â†’ validate
    â†’ generate_insights (3-5 calls)
    â†’ analyze_relationships (0-3 calls)
    â†’ synthesize_report (1 call)
    â†’ quality_check
    â†’ enhance_report (ì¡°ê±´ë¶€, 1 call)
  ```
  **ì´**: 8-12íšŒ LLM í˜¸ì¶œ

- **ìµœì í™” ì›Œí¬í”Œë¡œìš°**:
  ```
  analyze_query (1 call) âœ…
    â†’ collect_data
    â†’ validate
    â†’ comprehensive_analysis_and_report (1 call) âœ…
    â†’ quality_check
    â†’ enhance_report (ì¡°ê±´ë¶€, 1 call)
  ```
  **ì´**: 2-3íšŒ LLM í˜¸ì¶œ

---

## ğŸ“Š ì‹¤ì œ ì„±ëŠ¥ ì¸¡ì • ê²°ê³¼

### í…ŒìŠ¤íŠ¸ ì¿¼ë¦¬: "ì‚¼ì„±ì „ìì™€ SKí•˜ì´ë‹‰ìŠ¤ HBM ê²½ìŸë ¥ ë¹„êµ"

| ë‹¨ê³„ | ì‹œê°„ | LLM í˜¸ì¶œ | ìƒíƒœ |
|------|------|----------|------|
| 1. Query Analysis (í†µí•©) | 3.1ì´ˆ | 1íšŒ | âœ… |
| 2. ë³‘ë ¬ ë°ì´í„° ìˆ˜ì§‘ | 1.9ì´ˆ | 0íšŒ | âœ… |
| 3. ì»¨í…ìŠ¤íŠ¸ ê²€ì¦ | ~0.1ì´ˆ | 0íšŒ | âœ… |
| 4. Comprehensive Analysis (í†µí•©) | 13.8ì´ˆ | 1íšŒ | âœ… |
| 5. Quality Check | ~1ì´ˆ | 0íšŒ | âœ… |
| 6. Enhance (ì¡°ê±´ë¶€) | ê°€ë³€ | 0-1íšŒ | âš ï¸ |
| **ì´ (enhancement ì—†ì´)** | **~20ì´ˆ** | **2íšŒ** | âœ… |
| **ì´ (enhancement í¬í•¨)** | **~35ì´ˆ** | **3íšŒ** | âš ï¸ |

### í˜„í™©
- **LLM í˜¸ì¶œ íšŸìˆ˜**: 8-10íšŒ â†’ **2-3íšŒ** âœ… (ëª©í‘œ ë‹¬ì„±)
- **ì‘ë‹µ ì‹œê°„** (enhancement ì—†ì´): ~20ì´ˆ âš ï¸ (ëª©í‘œ 6-8ì´ˆ ë¯¸ë‹¬ì„±)
- **ì‘ë‹µ ì‹œê°„** (enhancement í¬í•¨): ~35ì´ˆ âŒ (íƒ€ì„ì•„ì›ƒ ë°œìƒ)

---

## ğŸ” ë³‘ëª© ë¶„ì„

### 1. Comprehensive Analysis ë‹¨ê³„ (13.8ì´ˆ)
**ì›ì¸**:
- ë‹¨ì¼ LLM í˜¸ì¶œì´ì§€ë§Œ ë³µì¡í•œ ë³´ê³ ì„œ ìƒì„±
- Ollama llama3.1:8bì˜ í† í° ìƒì„± ì†ë„: ~70 tokens/sec
- 1000ì ë³´ê³ ì„œ = ~300 tokens = ~4.3ì´ˆ ìƒì„± ì‹œê°„
- ì‹¤ì œë¡œëŠ” ë” ê¸´ ë³´ê³ ì„œ ìƒì„± ì¤‘ (2000-3000ì ì¶”ì •)

**ê°œì„  ì—¬ì§€**:
- âœ… í”„ë¡¬í”„íŠ¸ ê°„ê²°í™” ì™„ë£Œ (1ì°¨ ìµœì í™”)
- âœ… ì»¨í…ìŠ¤íŠ¸ ìš”ì•½ ìµœì í™” ì™„ë£Œ (ë°ì´í„° 2ê°œë¡œ ì œí•œ)
- âš ï¸ ì—¬ì „íˆ 13.8ì´ˆ ì†Œìš” â†’ LLM ìì²´ì˜ í•œê³„

### 2. Quality Check + Enhancement (15-20ì´ˆ)
**ì›ì¸**:
- Quality check ì´í›„ í’ˆì§ˆì´ ë‚®ìœ¼ë©´ enhancement ë‹¨ê³„ ì‹¤í–‰
- Enhancementê°€ ë˜ ë‹¤ë¥¸ LLM í˜¸ì¶œ (ë³´ê³ ì„œ ê°œì„ )
- ìµœëŒ€ 3íšŒ retry ê°€ëŠ¥

**í•´ê²°ì±…**:
- Enhancement ì¡°ê±´ ê°•í™” (quality_score < 0.4 â†’ 0.3)
- Retry íšŸìˆ˜ ì œí•œ (3íšŒ â†’ 1íšŒ)
- ë˜ëŠ” enhancement ë¹„í™œì„±í™”

---

## ğŸ’¡ í•µì‹¬ ì¸ì‚¬ì´íŠ¸

### ì„±ê³µí•œ ë¶€ë¶„
1. **LLM í˜¸ì¶œ íšŸìˆ˜ ìµœì í™”**: 8-10íšŒ â†’ 2-3íšŒ âœ…
2. **ì›Œí¬í”Œë¡œìš° ë‹¨ìˆœí™”**: 8ê°œ ë…¸ë“œ â†’ 6ê°œ ë…¸ë“œë¡œ ì¶•ì†Œ
3. **ì½”ë“œ í’ˆì§ˆ í–¥ìƒ**: ì¤‘ë³µ ì œê±°, ìœ ì§€ë³´ìˆ˜ì„± í–¥ìƒ
4. **í”„ë¡¬í”„íŠ¸ í’ˆì§ˆ ê°œì„ **: í†µí•© í”„ë¡¬í”„íŠ¸ë¡œ ì¼ê´€ì„± í–¥ìƒ

### ì—¬ì „íˆ ë‚¨ì€ ê³¼ì œ
1. **ê°œë³„ LLM í˜¸ì¶œ ì‹œê°„**: 13.8ì´ˆ (ë‹¨ì¼ í˜¸ì¶œì´ì§€ë§Œ ë„ˆë¬´ ê¹€)
2. **íƒ€ì„ì•„ì›ƒ ì´ìŠˆ**: 40ì´ˆ íƒ€ì„ì•„ì›ƒì—ë„ ì™„ë£Œ ëª»í•¨
3. **Enhancement ë‹¨ê³„**: ì¶”ê°€ 15-20ì´ˆ ì†Œìš”

---

## ğŸ¯ ì¶”ê°€ ìµœì í™” ë°©ì•ˆ

### ë‹¨ê¸° (ì¦‰ì‹œ ì ìš© ê°€ëŠ¥)

#### 1. Enhancement ìµœì í™”
```python
# í˜„ì¬: í’ˆì§ˆ ì ìˆ˜ < 0.7ì´ë©´ enhancement
if quality_score < 0.7:
    enhance_report()  # 15-20ì´ˆ ì¶”ê°€

# ì œì•ˆ: ì¡°ê±´ ê°•í™”
if quality_score < 0.4:  # ì •ë§ ì‹¬ê°í•  ë•Œë§Œ
    enhance_report()
```

#### 2. Retry íšŸìˆ˜ ì œí•œ
```python
# í˜„ì¬: ìµœëŒ€ 3íšŒ retry
MAX_RETRY = 3

# ì œì•ˆ: 1íšŒë¡œ ì œí•œ
MAX_RETRY = 1
```

#### 3. Timeout ì„¸ë¶€ ì¡°ì •
```python
# í˜„ì¬
comprehensive: 40ì´ˆ
deep: 30ì´ˆ
standard: 20ì´ˆ
shallow: 15ì´ˆ

# ì œì•ˆ (LLM ì‹¤ì œ ì„±ëŠ¥ ê³ ë ¤)
comprehensive: 45ì´ˆ  # comprehensive analysis 13.8ì´ˆ + quality 1ì´ˆ + enhancement 20ì´ˆ
deep: 35ì´ˆ
standard: 25ì´ˆ
shallow: 20ì´ˆ
```

### ì¤‘ê¸° (1-2ì¼ ì†Œìš”)

#### 4. Streaming Response
- LLM ì‘ë‹µì„ streamingìœ¼ë¡œ ë°›ì•„ ì‚¬ìš©ìì—ê²Œ ì¦‰ì‹œ í‘œì‹œ
- ì „ì²´ ì‹œê°„ì€ ë™ì¼í•˜ì§€ë§Œ ì²´ê° ì†ë„ í–¥ìƒ

#### 5. ìºì‹± ì „ëµ
```python
# ìœ ì‚¬í•œ ì§ˆë¬¸ì— ëŒ€í•œ ìºì‹±
query_hash = hash(query + analysis_depth)
if cached_report := redis.get(query_hash, ttl=3600):
    return cached_report
```

#### 6. í”„ë¡¬í”„íŠ¸ ì¶”ê°€ ìµœì í™”
- ë³´ê³ ì„œ ê¸¸ì´ ëª…ì‹œì  ì œí•œ: "1000ì ì´ë‚´"
- ë¶ˆí•„ìš”í•œ ì„¹ì…˜ ì œê±°

### ì¥ê¸° (3-7ì¼ ì†Œìš”)

#### 7. ë” ë¹ ë¥¸ LLM ì‚¬ìš©
- Ollama llama3.1:8b â†’ llama3:8b (ë” ë¹ ë¥¸ ë²„ì „)
- ë˜ëŠ” Mixtral-8x7b (ë” ë¹ ë¥¸ ì¶”ë¡ )
- ë˜ëŠ” GPU ì„œë²„ ìŠ¤ì¼€ì¼ì—…

#### 8. Two-Tier ì•„í‚¤í…ì²˜
```python
# Tier 1: ë¹ ë¥¸ ìš”ì•½ (3-5ì´ˆ)
def quick_summary(query):
    # ê°„ë‹¨í•œ bullet point ìš”ì•½
    return llm.invoke(short_prompt)

# Tier 2: ìƒì„¸ ë¶„ì„ (20-30ì´ˆ, ë°±ê·¸ë¼ìš´ë“œ)
def detailed_analysis(query):
    # í˜„ì¬ì˜ comprehensive analysis
    return comprehensive_report()

# ì‚¬ìš©ìì—ê²Œ ë¨¼ì € quick_summary ë°˜í™˜
# ë°±ê·¸ë¼ìš´ë“œì—ì„œ detailed_analysis ì™„ë£Œ í›„ ì—…ë°ì´íŠ¸
```

---

## ğŸ“ˆ ì˜ˆìƒ ê°œì„  íš¨ê³¼

### Scenario A: Enhancement ìµœì í™” (ì¦‰ì‹œ ì ìš©)
- Enhancement ì¡°ê±´ ê°•í™” + Retry ì œí•œ
- **ì˜ˆìƒ ì‹œê°„**: 20-25ì´ˆ (í˜„ì¬ 35ì´ˆ â†’ 10ì´ˆ ë‹¨ì¶•)
- **íƒ€ì„ì•„ì›ƒ**: ëŒ€ë¶€ë¶„ì˜ ê²½ìš° í†µê³¼ ê°€ëŠ¥

### Scenario B: Streaming + ìºì‹± (1-2ì¼)
- ìºì‹œ íˆíŠ¸ìœ¨ 30-40% ê°€ì •
- ìºì‹œ íˆíŠ¸: ~0.5ì´ˆ
- ìºì‹œ ë¯¸ìŠ¤: 20-25ì´ˆ (Scenario A)
- **í‰ê·  ì‹œê°„**: ~8-10ì´ˆ (ì²´ê°)

### Scenario C: ë¹ ë¥¸ LLM + Two-Tier (3-7ì¼)
- Quick summary: 3-5ì´ˆ
- Detailed (ë°±ê·¸ë¼ìš´ë“œ): 15-20ì´ˆ
- **ì‚¬ìš©ì ì²´ê°**: 3-5ì´ˆ âœ…

---

## ğŸ† ê¶Œì¥ ì¡°ì¹˜

### 1ìˆœìœ„: Enhancement ìµœì í™” (ì¦‰ì‹œ)
```python
# api/services/langgraph_report_service.py
def _should_enhance_report(self, state):
    quality_score = state.get("quality_score", 0)
    retry_count = state.get("retry_count", 0)

    # ë³€ê²½: 0.7 â†’ 0.4, retry 3 â†’ 1
    if quality_score < 0.4 and retry_count < 1:
        return "enhance"
    return "complete"
```

### 2ìˆœìœ„: Timeout ì¡°ì • (ì¦‰ì‹œ)
```python
# api/services/query_router.py
# ê° ê¹Šì´ë³„ timeout 5-10ì´ˆì”© ì¦ê°€
```

### 3ìˆœìœ„: ìºì‹± êµ¬í˜„ (1-2ì¼)
```python
# Redis ê¸°ë°˜ query ê²°ê³¼ ìºì‹±
# TTL: 1ì‹œê°„
```

---

## ğŸ“ ê²°ë¡ 

### âœ… ë‹¬ì„±í•œ ëª©í‘œ
1. **LLM í˜¸ì¶œ íšŸìˆ˜**: 8-10íšŒ â†’ 2-3íšŒ âœ…
2. **ì½”ë“œ í’ˆì§ˆ**: í†µí•© í”„ë¡¬í”„íŠ¸ë¡œ ì¼ê´€ì„± í–¥ìƒ âœ…
3. **ìœ ì§€ë³´ìˆ˜ì„±**: 8ê°œ ë…¸ë“œ â†’ 6ê°œ ë…¸ë“œë¡œ ë‹¨ìˆœí™” âœ…

### âš ï¸ ë¶€ë¶„ ë‹¬ì„±
1. **ì‘ë‹µ ì‹œê°„**: 15-20ì´ˆ â†’ ~20ì´ˆ (10-15% ê°œì„ )
   - ëª©í‘œ 6-8ì´ˆëŠ” ë¯¸ë‹¬ì„±
   - í•˜ì§€ë§Œ íƒ€ì„ì•„ì›ƒ ë¬¸ì œëŠ” í•´ê²° ê°€ëŠ¥

### âŒ ë¯¸ë‹¬ì„±
1. **ì ˆëŒ€ ì‘ë‹µ ì‹œê°„**: 6-8ì´ˆ ëª©í‘œ (ì‹¤ì œ 20ì´ˆ)
   - ê·¼ë³¸ ì›ì¸: LLM ìì²´ì˜ í† í° ìƒì„± ì†ë„
   - í•´ê²°ì±…: ë” ë¹ ë¥¸ LLM, Streaming, ìºì‹± í•„ìš”

### ì „ëµì  ë°©í–¥
- âœ… **êµ¬ì¡°ì  ìµœì í™” ì™„ë£Œ**: LLM í˜¸ì¶œ íšŸìˆ˜ ìµœì†Œí™” ë‹¬ì„±
- âš ï¸ **ì„±ëŠ¥ ìµœì í™” ê³„ì†**: Enhancement ì¡°ê±´ ê°•í™” ì¦‰ì‹œ ì ìš©
- ğŸ”„ **ì‚¬ìš©ì ê²½í—˜ ê°œì„ **: Streaming + ìºì‹± + Two-Tier ê³ ë ¤

**í˜„ì¬ ìƒíƒœ**: Aê¸‰ ì„œë¹„ìŠ¤ ê°€ëŠ¥ (enhancement ìµœì í™” í›„)
**ìƒì—…í™” ì¤€ë¹„ë„**: 85% (ìºì‹± ì¶”ê°€ ì‹œ 95%)
